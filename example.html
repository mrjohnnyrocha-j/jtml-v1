<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>JTML Final Example</title>
</head>
<body>
<!-- DefineStatementNode(identifier=user, expression={"name": Alice, "hoverCount": 0.000000000000000}) not explicitly transpiled. -->
<!-- DefineStatementNode(identifier=userInput, expression=) not explicitly transpiled. -->
<!-- FunctionDeclarationNode(name=setUserName, parameters=[{name: newName, type: }, ], returnType=, body=[AssignmentStatementNode(lhs=user[name], rhs=newName), ]) not explicitly transpiled. -->
<!-- FunctionDeclarationNode(name=applyName, parameters=[], returnType=, body=[AssignmentStatementNode(lhs=user[name], rhs=j), ]) not explicitly transpiled. -->
<!-- FunctionDeclarationNode(name=incrementHover, parameters=[], returnType=, body=[AssignmentStatementNode(lhs=user[hoverCount], rhs=(user[hoverCount] + 1.000000000000000)), ]) not explicitly transpiled. -->
<!-- DeriveStatementNode(identifier=userClicksSquare, declaredType=, expression=(user[hoverCount] * 2.000000000000000)) not explicitly transpiled. -->
<div id="elem_1" data-jtml-attr-class="attr_1"><div id="expr_2">{{(Current user:  + user[name])}}</div>
<input id="elem_2" data-jtml-attr-id="attr_3" data-jtml-attr-placeholder="attr_4" onInput="sendEvent('attr_5', 'onInput', ['setUserName()', event.target.value])"></input>
<button id="elem_3" data-jtml-attr-id="attr_6" onClick="sendEvent('attr_7', 'onClick', ['applyName()'])"><div id="expr_8">{{Apply Name}}</div>
</button>
<div id="elem_4" data-jtml-attr-class="attr_9" data-jtml-attr-id="attr_10" onMouseOver="sendEvent('attr_11', 'onMouseOver', ['incrementHover()'])"><div id="expr_12">{{(((Hover over me! Hover count:  + user[hoverCount]) +  and square of it: ) + userClicksSquare)}}</div>
</div>
</div>

  <script>
        const ws = new WebSocket('ws://localhost:8080');

        ws.onopen = () => {
            console.log('WebSocket connection established.');
        };

        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            if (message.type === 'populateBindings') {
                const bindings = message.bindings;
                // Handle content bindings
                if (bindings.content) {
                    for (const [elementId, value] of Object.entries(bindings.content)) {
                        const elem = document.getElementById(elementId);
                        if (elem) {
                            elem.textContent = value;
                        }
                    }
                }
                // Handle attribute bindings
                if (bindings.attributes) {
                    for (const [elementId, attrs] of Object.entries(bindings.attributes)) {
                        const elem = document.getElementById(elementId);
                        if (elem) {
                            for (const [attr, value] of Object.entries(attrs)) {
                                elem.setAttribute(attr, value);
                            }
                        }
                    }
                }
            }
            else if (message.type === 'updateBinding') {
                const elementId = message.elementId;
                const value = message.value;
                const elem = document.getElementById(elementId);
                if (elem) {
                    elem.textContent = value;
                }
                if (message.type === 'attribute') {
                    const elem = document.getElementById(binding.elementId);
                    if (elem) {
                        elem.setAttribute(binding.attribute, binding.value);
                    }
                }
            }
            else if (message.type === 'acknowledgment') {
                console.log('Acknowledgment:', message.message);
            }
            else if (message.type === 'error') {
                console.error('Error from server:', message.error);
            }
        };

        ws.onclose = () => {
            console.log('WebSocket connection closed.');
        };

        // Function to send events to the server
        function sendEvent(elementId, eventType, args = []) {
            // Check if WebSocket connection is open
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'event',
                    elementId: elementId,
                    eventType: eventType,
                    args: args
                };
                try {
                    ws.send(JSON.stringify(message));
                    console.log(`[DEBUG] Sent event: ${JSON.stringify(message)}`);
                } catch (error) {
                    console.error(`[ERROR] Failed to send event: ${error.message}`);
                }
            } else {
                console.error(`[ERROR] WebSocket is not open. Event not sent: ElementID=${elementId}, EventType=${eventType}`);
            }
        }

      
    </script>
    
</body>
</html>
